#!/usr/bin/perl -w
use strict;
use JSON::XS;
use GDBM_File;
use Data::Dumper;

my $tagfile = '/var/http/bmffd/bmfft/db/tags.db';
my $metafile = '/var/http/bmffd/bmfft/db/meta.db';

my $files;
my $size;
my $untagged;

my %hash;
my %metahash;
tie %hash, 'GDBM_File', $tagfile, &GDBM_READER, 0640 or die('Could not open db');
for my $key (keys %hash) {
	my $value = $hash{$key};
	$value = decode_json($value);
	my %value = %{$value};
	$size += $value->{'size'} if $value->{'size'};
	$files++;
	if (!defined $value->{'namespaces'}) { $untagged++; }
}
print "Files: $files\n";
print 'Size: '.scaledbytes($size)."\n";
print "Untagged: $untagged\n";
untie %hash;
tie %metahash, 'GDBM_File', $metafile, &GDBM_WRITER, 0640 or die('Could not open meta file');
$metahash{'size'} = $size;
$metahash{'untagged'} = $untagged;
$metahash{'files'} = $files;
untie %metahash;
sub scaledbytes {
    (sort { length $a <=> length $b
          } map { sprintf '%.3g%s', $_[0]/1024**$_->[1], $_->[0]
                }[" bytes"=>0]
                ,[KB=>1]
                ,[MB=>2]
                ,[GB=>3]
                ,[TB=>4]
                ,[PB=>5]
                ,[EB=>6]
    )[0]
}
